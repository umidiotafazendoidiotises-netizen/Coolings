-- SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

print("[TSC Hub] Script started - loading Rayfield")

-- Load Rayfield (stable mirror first)
local Rayfield
local loadSuccess, loadErr = pcall(function()
   Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/SiriusSoftwareLtd/Rayfield/main/source.lua'))()
end)

if not loadSuccess or not Rayfield then
   print("[TSC Hub] GitHub load failed: " .. tostring(loadErr))
   print("[TSC Hub] Trying sirius.menu fallback...")
   loadSuccess, loadErr = pcall(function()
      Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
   end)
end

if not loadSuccess or not Rayfield then
   print("[TSC Hub] Rayfield failed to load completely: " .. tostring(loadErr))
   return
end

print("[TSC Hub] Rayfield loaded successfully")

-- Create Window
local Window = Rayfield:CreateWindow({
   Name = "Thunder Scientific Corporation Hub",
   LoadingTitle = "yeah, someone had to do it",
   LoadingSubtitle = "by lollipop",
   ConfigurationSaving = { Enabled = false },
   Discord = { Enabled = true, Invite = "BJupXS7qjW", RememberJoins = false },
   KeySystem = false
})

-- Define state & constants
local GROUP_ID = 33326090
local notifierEnabled = false
local trashEnabled = false
local loopTask = nil
local activeTween = nil
local noStaffShown = false
local trashInterval = 7  -- default seconds

local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")

-- Create custom notifier GUI FIRST
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GroupNotifier"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 320, 0, 80)
frame.Position = UDim2.new(1, 20, 0.5, -40)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = frame

local image = Instance.new("ImageLabel")
image.Size = UDim2.new(0, 60, 0, 60)
image.Position = UDim2.new(0, 10, 0.5, -30)
image.BackgroundTransparency = 1
image.Parent = frame

local nameLabel = Instance.new("TextLabel")
nameLabel.Size = UDim2.new(1, -80, 0, 32)
nameLabel.Position = UDim2.new(0, 80, 0, 10)
nameLabel.BackgroundTransparency = 1
nameLabel.TextColor3 = Color3.new(1,1,1)
nameLabel.Font = Enum.Font.GothamBold
nameLabel.TextSize = 18
nameLabel.TextXAlignment = Enum.TextXAlignment.Left
nameLabel.Parent = frame

local roleLabel = Instance.new("TextLabel")
roleLabel.Size = UDim2.new(1, -80, 0, 24)
roleLabel.Position = UDim2.new(0, 80, 0, 42)
roleLabel.BackgroundTransparency = 1
roleLabel.TextColor3 = Color3.fromRGB(180,180,180)
roleLabel.Font = Enum.Font.Gotham
roleLabel.TextSize = 15
roleLabel.TextXAlignment = Enum.TextXAlignment.Left
roleLabel.Parent = frame

-- Helper functions
local function getPlayerIcon(userId)
   local success, content = pcall(function()
      return Players:GetUserThumbnailAsync(userId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
   end)
   return success and content or ""
end

local function playTween()
   if not notifierEnabled then return end
   if not frame then return end
   if activeTween then activeTween:Cancel() end

   local inPos = UDim2.new(1, -340, 0.5, -40)
   local outPos = UDim2.new(1, 20, 0.5, -40)

   frame.Position = outPos

   local tweenIn = TweenService:Create(frame, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Position = inPos})
   activeTween = tweenIn
   tweenIn:Play()
   tweenIn.Completed:Wait()

   task.wait(3)

   local tweenOut = TweenService:Create(frame, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Position = outPos})
   activeTween = tweenOut
   tweenOut:Play()
end

local function showPlayerNotification(player, role, joined)
   if not notifierEnabled then return end
   if not image or not nameLabel or not roleLabel then return end

   image.Visible = true
   image.Image = getPlayerIcon(player.UserId)
   nameLabel.Text = player.Name .. (joined and " joined" or " left")
   roleLabel.Text = role
   playTween()
end

local function showNoStaffNotification()
   if not notifierEnabled or noStaffShown then return end
   if not image or not nameLabel or not roleLabel then return end

   noStaffShown = true
   image.Visible = false
   nameLabel.Text = "No mod/admin found"
   roleLabel.Text = "in this server"
   playTween()
end

local function countStaff()
   local count = 0
   for _, p in Players:GetPlayers() do
      if p:GetRankInGroup(GROUP_ID) > 0 then
         count += 1
      end
   end
   return count
end

local function handleNoStaffCheck()
   if not notifierEnabled then return end
   if countStaff() == 0 then
      showNoStaffNotification()
   else
      noStaffShown = false
   end
end

local function printGroupMembersOnce()
   print("----- Group Members In Server (ID: " .. GROUP_ID .. ") -----")
   local found = false
   for _, player in Players:GetPlayers() do
      local rank = player:GetRankInGroup(GROUP_ID)
      if rank > 0 then
         found = true
         local role = player:GetRoleInGroup(GROUP_ID)
         print(player.Name .. " | Role: " .. role .. " | Rank: " .. rank)
      end
   end
   if not found then
      print("No group members found in server right now.")
   end
   print("-----------------------------------")
end

-- Tabs
local NotifierTab = Window:CreateTab("Group Notifier", nil)

NotifierTab:CreateSection("Controls")

NotifierTab:CreateToggle({
   Name = "Notifier Enabled",
   CurrentValue = false,
   Callback = function(Value)
      print("[DEBUG] Notifier toggle set to: " .. tostring(Value))
      notifierEnabled = Value
      Rayfield:Notify({
         Title = "Group Notifier",
         Content = Value and "Enabled" or "Disabled",
         Duration = 3.5,
         Image = 4483362458
      })
      if Value then
         handleNoStaffCheck()
      end
   end
})

NotifierTab:CreateButton({
   Name = "Print Current Staff List",
   Callback = function()
      print("[DEBUG] Print button pressed")
      printGroupMembersOnce()
      Rayfield:Notify({
         Title = "Staff List",
         Content = "Printed to console",
         Duration = 3
      })
   end
})

NotifierTab:CreateParagraph({
   Title = "Group Notifier",
   Content = "This will notify you if there is a admin/mod/dev on your server, if they left or if one just joined, be careful cuz they have no life and will mod all day"
})

-- Trash Grab Tab
local TrashTab = Window:CreateTab("Trash Grab", nil)

TrashTab:CreateSection("Controls")

-- Interval slider (1 to 30 seconds)
local intervalSlider = TrashTab:CreateSlider({
   Name = "Delay Between Grabs",
   Range = {1, 30},
   Increment = 1,
   Suffix = " seconds",
   CurrentValue = 7,
   Flag = "TrashInterval",
   Callback = function(Value)
      trashInterval = Value
      print("[DEBUG] Trash interval set to: " .. Value .. " seconds")
      Rayfield:Notify({
         Title = "Trash Grab",
         Content = "Delay updated to " .. Value .. " seconds",
         Duration = 3
      })
   end
})

TrashTab:CreateToggle({
   Name = "Trash Grab Enabled",
   CurrentValue = false,
   Callback = function(Value)
      print("[DEBUG] Trash toggle set to: " .. tostring(Value))
      trashEnabled = Value
      if Value then
         if loopTask then task.cancel(loopTask) end
         loopTask = task.spawn(function()
            while trashEnabled do
               task.wait(trashInterval)
               local remotes = ReplicatedStorage:FindFirstChild("Remotes")
               if remotes then
                  local incinerators = remotes:FindFirstChild("Incinerators")
                  if incinerators then
                     local event = incinerators:FindFirstChild("TrashGrabEvent")
                     if event then
                        pcall(event.FireServer, event)
                     end
                  end
               end
            end
         end)
         Rayfield:Notify({Title = "Trash Grab", Content = "ON", Duration = 3.5})
         print("TrashGrab: ON")
      else
         if loopTask then task.cancel(loopTask) loopTask = nil end
         Rayfield:Notify({Title = "Trash Grab", Content = "OFF", Duration = 3.5})
         print("TrashGrab: OFF")
      end
   end
})

TrashTab:CreateParagraph({
   Title = "Trash Grab Info",
   Content = "You need to be close from the trash thing for this to work, !ANYTHING BELOW 7 WILL MAKE ADMINS SUSPICIOUS AND THE TRASH WILL PROBABLY GIVE NO MONEY!"
})

-- Events
Players.PlayerAdded:Connect(function(player)
   if notifierEnabled and player:GetRankInGroup(GROUP_ID) > 0 then
      local role = player:GetRoleInGroup(GROUP_ID)
      showPlayerNotification(player, role, true)
   end
   handleNoStaffCheck()
end)

Players.PlayerRemoving:Connect(function(player)
   if notifierEnabled and player:GetRankInGroup(GROUP_ID) > 0 then
      local role = player:GetRoleInGroup(GROUP_ID)
      showPlayerNotification(player, role, false)
   end
   handleNoStaffCheck()
end)

printGroupMembersOnce()

print("[TSC Hub] Script fully loaded - ready to use")
